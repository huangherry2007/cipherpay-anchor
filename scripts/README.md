# 🛡️ CipherPay-Anchor: ZK Proof Utility Scripts

This directory contains helper scripts for generating and verifying zero-knowledge proofs using Circom and Groth16 for the `cipherpay-anchor` Solana smart contract.

---

## ⚙️ Prerequisites

Install the following dependencies:

```bash
npm install circomlibjs
npm install -g snarkjs
```

---

## 📜 Available Scripts

### 1. `generate_input_deposit.js`

Generates a deterministic `input_deposit.json` file to test the `deposit.circom` circuit.

```bash
node scripts/generate_input_deposit.js
```

🔹 Output: `tests/input_deposit.json`

**Note**: This is a simplified version that generates deterministic test data. For production use, you'll want to implement proper cryptographic hashing.

Use with snarkjs:

```bash
npx snarkjs groth16 fullprove proofs/input_deposit.json ../cipherpay-circuits/build/deposit/deposit_js/deposit.wasm ../cipherpay-circuits/build/deposit/deposit.zkey proofs/deposit_proof.json
```

```split way : witness -> prove -> verfiy
.witness
node ../cipherpay-circuits/build/deposit/deposit_js/generate_witness.js ../cipherpay-circuits/build/deposit/deposit_js/deposit.wasm proofs/input_deposit.json proofs/witness_deposit.wtns
.verificaton key
npx snarkjs zkey export verificationkey ../cipherpay-circuits/build/deposit/deposit.zkey proofs/vkey_deposit.json
.prove
npx snarkjs groth16 prove ../cipherpay-circuits/build/deposit/deposit.zkey proofs/witness_deposit.wtns proofs/deposit_proof.json proofs/deposit_public.json
.verify
npx snarkjs groth16 verify proofs/vkey_deposit.json proofs/deposit_public.json proofs/deposit_proof.json

### 2. `toBytes.js`

Converts a JSON-format Groth16 proof to a binary file for on-chain use in Solana.

```bash
node scripts/toBytes.js <input_json> <output_bin>
```

🔹 Example:

```bash
node scripts/toBytes.js proofs/deposit_proof.json proofs/deposit_proof.bin
```

---

### 3. `extractPublicInputs.js`

Extracts the `publicSignals` array from a `deposit_proof.json` file and writes it to a separate JSON file.

```bash
node scripts/extractPublicInputs.js <input_json> <output_json>
```

🔹 Example:

```bash
node scripts/extractPublicInputs.js proofs/deposit_proof.json proofs/deposit_public_inputs.json
```

---

### 4. `generate_idl.js`

Generates the Anchor IDL (Interface Definition Language) file manually for the CipherPay program.

```bash
node scripts/generate_idl.js
```

🔹 Output: `target/idl/cipherpay_anchor.json`

---

## 🧩 Circuit Public Signals

The `deposit.circom` circuit must output the following public signals **in this order**:

1. `amount`
2. `depositHash`
3. `newCommitment`
4. `ownerCipherPayPubKey`
5. `merkleRoot`
6. `nextLeafIndex`

Make sure your Solana verifier uses the same order for verifying Groth16 proofs.

---

## 📁 Folder Structure

```
scripts/
├── generate_input_deposit.js   # Generate input JSON for the circuit
├── toBytes.js                  # Convert proof JSON to binary format
├── extractPublicInputs.js      # Extract public inputs from proof JSON
├── generate_idl.js             # Generate Anchor IDL file
├── README.md                   # This file
proofs/
├── deposit_proof.json          # Output of snarkjs fullprove
├── deposit_proof.bin           # Binary proof for Solana on-chain use
├── deposit_public_inputs.json  # Extracted public signals
tests/
└── input_deposit.json          # Circuit input file generated by generate_input_deposit.js
```

---

## ✅ Optional Enhancements

Want to improve your workflow? Consider adding:

* A `generateProof.sh` to automate fullprove, toBytes, and extraction
* Anchor tests to verify proofs on-chain

---

## 🔧 Troubleshooting

### GLIBC Version Issues

If you encounter GLIBC version errors with Anchor CLI:

1. **Use older Anchor version**: `avm install 0.29.0`
2. **Use manual IDL generation**: Run `node scripts/generate_idl.js`
3. **Use cargo build directly**: `cargo build` instead of `anchor build`

### Solana Toolchain Issues

If you get `build-bpf` errors:

1. **Update Solana**: `sh -c "$(curl -sSfL https://release.solana.com/v1.17.0/install)"`
2. **Use manual type definitions**: The types are already generated in `target/types/cipherpay_anchor.ts`

### Environment Variables

Set these for testing:

```bash
export ANCHOR_PROVIDER_URL="http://127.0.0.1:8899"
export ANCHOR_WALLET="~/.config/solana/id.json"
```
